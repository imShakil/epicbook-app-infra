trigger: 
  - main

pool:
  name: 'aws-ubuntu'

variables: 
  - group: terraform-variables
  - group: aws-credentials

stages:
  - stage: terraformAction
    jobs:
      - job: terraformAction
        workspace:
          clean: all
        steps:

          - script: |
              aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
              aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
              aws configure set default.region $(AWS_REGION)
            displayName: 'AWS configure'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "Verify terraform files"
              ls -la
            displayName: 'Verify terraform files'
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
          
          - task: DownloadSecureFile@1
            name: download_ssh_key
            inputs:
              secureFile: 'id_rsa.pub'

          - script: |
              echo "Copying SSH public key into Terraform module"
              rm -rf ~/.ssh/
              mkdir -p ~/.ssh
              cp $(download_ssh_key.secureFilePath) ~/.ssh/id_rsa.pub
              ls -la ~/.ssh/
            displayName: 'Extract SSH Public Key for Terraform'

          - script: |
              cat > terraform.tfvars << EOF
              prefix             = "$(TF_PREFIX)"
              db_admin           = "$(TF_RDS_ADMIN)"
              db_admin_password  = "$(TF_RDS_ADMIN_PASSWORD)"
              EOF
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
            displayName: 'Create terraform.tfvars'

          - script: |
              echo "Terraform init"
              terraform init
            displayName: 'Terraform init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
          - script: |
              echo "Terraform plan"
              terraform plan -out=tfplan
            displayName: 'Terraform plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
          - script: |
              echo "Terraform apply"
              terraform apply -auto-approve tfplan
            displayName: 'Terraform apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
          
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/terraform/terraform.tfvars'
              artifact: 'terraform.tfvars'
            displayName: 'Publish terraform.tfvars'
        
  - stage: ManualDestroy
    dependsOn: terraformAction
    condition: succeeded('terraformAction')
    jobs:
       - deployment: approveDestroy
         environment: 'ManualDestroy'
         strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
                    aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
                    aws configure set region $(AWS_REGION)
                  displayName: 'Configure AWS CLI'
                
                - task: DownloadPipelineArtifact@2
                  inputs:
                    artifactName: 'terraform.tfvars'
                    targetPath: '$(System.DefaultWorkingDirectory)/terraform'
                  displayName: 'Download Terraform vars'

                - script: |
                    ls -la
                    terraform init -upgrade
                    terraform destroy -auto-approve
                  workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
                  displayName: 'Manual Destroy'

                - script: |
                    echo "cleanup"
                    rm -rf ~/.ssh/id_rsa.pub
                    rm -f ~/.aws/credentials ~/.aws/config
                    rm -rf $(System.DefaultWorkingDirectory)/*
                  displayName: 'Cleanup workspace'
